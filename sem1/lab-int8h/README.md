# Лабораторная работа №1

#### Установка необходимого ПО

Запустите скрипт 'download.sh' с помощью команды:

```./download.sh```

Если произошла ошибка, можно посмотреть код скрипта и установить все вручную по указанным ссылкам.

#### Задача 1

Запускаем виртуальную машину Windows XP и установливаем SOURCER и отладчик DEBUG (при необходимости).

#### Задача 2

Используя отладчик DEBUG получаем адрес вектора int8h из таблицы векторов прерываний.

1. Вектор 8-го прерывания имеет смещение 4 * 8 = 32 = 20h в hex.

2. Получаем содержимое 4-х байтов в hex с помощью команды `-D 0000:0020 L 4`: `4607:0C02`.

3. Учитываем обратный порядок следования байтов: `смещение:сегмент` - сначала идет младшая часть, а потом старшая. Получаем `020C:0746`.

![](https://github.com/user-attachments/assets/fd74d2f2-9646-4a41-8ef3-70a7943df8c0)

#### Задача 3

1. Запускаем SOURCER - `sr.exe`.

2. Указываем начальный адрес `020C:0746` и конечный адрес `020C:FFFF` (примерный, мы не знаем точный, код обработчика прерывания заканчивается командой `iret`).

![](https://github.com/user-attachments/assets/d660e593-3542-4300-8ba2-d27243c7fb2b)


#### Задача 4

Изучаем полученный [код](https://github.com/unaun0/bmstu-os/blob/lab1/lab1/main/asserts/int8h_code.txt), делаем схемы алгоритмов `int8h`, `sub_2` и отчет.

## Вопросы для защиты

#### Как называются 4 push в начале?

- Сохранение аппаратного контекста.

#### Почему при сохранении аппаратного контекста нет FLAGS и IP?

- В DOS, при вызове прерывания, процессор автоматически сохраняет FLAGS и IP на стеке, но это происходит до вызова обработчика прерывания. Это связано с тем, что обработчик прерывания int 8h является частью ядра DOS и должен работать быстро и эффективно.

#### Что значит каждая из колонок листинга?

- Адреса (сегмент:смещение), машинный код, команды ассемблера, комментарии.

#### Как получить адрес обработчика прерывания?

- Таблица векторов прерываний располагается по нулевому адресу в памяти. Зная номер прерывания, можно получить смещение в этой таблице, по которому расположен дальний (far) адрес обработчика прерывания. Длина дальнеге адреса - 4 байта, следовательно, `4 * 8 = 32` в десятичной с.c., `20h` - в шестнадцатиричной. С помощью отладчика находим адрес прерывания по вычисленному смещению. Нужно учитывать, что в нашей ОС используется обратный порядок записи байтов, пожтому необходимо перевернуть полученные 4 байта.

#### Как получить реально время, если известен адрес, по которому хранится число тиков с момента старта системы?

- Нужно поделить число тиков на 18.2, получим время в миллисекундах.

#### Что делает подпрограмма sub? Зачем?

- Запрешает маскируемые прерывания. Подпрограмма sub вызывается для того, чтобы запретить обработчик прерывания int 8h, так как оно происходит 18.2 раз в секунду.

#### Для чего посылается команда 20h в порт 20h?

- Уведомление контроллера прерываний, что прерывание было обработано. Разрешение всех прерываний.

#### Зачем сохраняем флаги в AH? (команда lahf)

- Регистр флагов недоступен, поэтому записываем флаги в регистр AH (`sahf`), выполняем какие-то операции, возможно, изменяющие флаги, после чего восстанавливаем флаги.

#### Зачем сохраняем флаги перед косвенным вызовом 1Ch?

- Это связано с тем, что при косвенном вызове прерывания через адрес в памяти (`call dword ptr es:[70h]`), флаги не сохраняются на стеке автоматически, потому что косвенный вызов прерывания является обычным вызовом подпрограммы. А внутри int 1Ch находится команда `iret`, которая меняет FLAGS.

#### Что такое маскируемые и не маскируемые прерывания?

- Маскируемые прерывания вызываются по маске - вызов таких прерываний можно запретить. Маска является данным, поэтому передается по шине данных.
- Не маскируемые прерывания запретить нельзя (например, системные ошибки).

#### Как называется команда `call dword ptr:es[70h]`?

- Косвенный вызов 1Сh, т. е. с помощью самого адреса команды.

#### Что находится внутри обработчика прерывания 1Ch?

- Это заглушка, внутри находится `iret`.

#### Зачем нужно прерывание 1Сh, когда есть 8h?

- 1Ch - программное прерывание, а 8h - аппаратаное прерывание с самым высоким приоритетом (все процессорное время будет занято выполнением кода int8h). 1Ch нужно для того, чтобы программисты не грузили int8h, так как может произойти сбой.

#### Что за адрес - 0040:0314h?

- Область данных BIOS, где содержится копия флагов, IF (10 бит) - флаг разрешения прерывания (1 - разрешено, 0 - запрещено).

#### Как называется такой действие в системе как отключение моторчика дисковода?

- Отложенное действие.

#### Зачем ведется отчет времени до отключения моторчика дисковода?

- Чтобы исключить непроизводственные затраты времени. Операции ввода-вывода могут идти последовательно, например, когда читаем массив, и моторчик включен в течение 2 секунд, чтобы не раскручивать его заново.

#### Для чего нужна команда lock перед AND?

- Команда lock блокирует локальную шину памяти, чтобы ни одна команда ДО не смогла обратиться к памяти, потому что AND обращается к памяти два раза - очень долго.