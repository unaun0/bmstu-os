# Прерывания

## Softirq

Отложенные гибкие прерывания (10 прерываний) определяются статически во время компиляции ядра.

## Тасклеты

* **Показать линии IRQ `cat /proc/interrupts`**

Первый это стандартный обработчик прерываний, а второй наш

* **Разновидностью чего является тасклет?**

softirq

* **Что такое softirq?**

Отложенные действия

* **Какие прерывания делятся на аппаратные и отложенные (top half и bottom half)?**

Медленные (то есть все, кроме таймера)

* **Какой демон отвечает за выполнение тасклетов?**

ksoftirq daemon

* **Что нужно вызвать в обработчике аппаратного прерывания чтобы в последствии выполнился тасклет?**

Нужно с помощью `tasklet_schedule` запланировать на выполнение

* **На каком процессоре будет выполняться тасклет?**

На котором выполнялось аппаратное прерывание

* **Почему именно ksoftirq deamon отвечает за тасклеты?**

Тасклеты это вид softirq

* **Кто ставит работы на выполнение**?

Планировщик ядра стандартный

* **Зачем тасклет?**

Для реализации собственных отложенных действий.
Тасклеты не сериализуются: в один момент может выполняться только один экземпляр тасклетов в системе, поэтому в коде тасклета не надо реализовывать средства строгого взаимоисключения (поэтому они параллельно выполняться не могут).
softirq может параллельно выполняться, а тасклет нет.

**Если важна скорость обработки, то используем softirq, поскольку там есть взаимоисключения и мы можем разделять выполнение на разные процессоры.**

**Линия IRQ разделяется обработчиками прерываний (с помощью флага `IRQF_SHARED`).**

## Работы

* **Как создаётся работа?**

1) Сначала вызывается функция `request_irq`, в которую передаются номер линии IRQ, обработчик аппаратного прерывания, флаг `IRQF_SHARED`, название обработчика, указатель на обработчик для дальнейшего освобождения линии IRQ (в `exit`).
2) Создаётся очередь работ, создаются две работы и инициализируются, после чего добавляются в очередь работ в обработчике аппаратного прерывания.

**Работа (именно работа, не очередь) может быть заблокирована.**

* **Кто будет отвечать за выполнение работы?**

Поток ядра `kworker`

**Просит показать очереди и kworker-ы (потоки ядра)**

`ps -ajx`

* **А что по факту делает макрос INIT_WORK?**

Инициализирует поля структуры `work_struct`

## Еще вопросы

* **На что заменяются аппаратные прерывания если много приходит прерываний?**

Ядро использует napi polling (опросы)

* **Отличие тасклета от работ?**

Работы могут быть параллельными, выполняться на разных процессорах и блокированы; работы выполняются в контексте потока ядра (kworker'a), а тасклеты в контексте аппаратного прерывания.
