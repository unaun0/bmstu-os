# –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã

* VFS –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –∫–æ—Ç–æ—Ä—ã–π –¥–æ–ª–∂–Ω—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ñ–∞–π–ª–æ–≤—ã–µ —Å–∏—Å—Ç–µ–º—ã, —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞—Ç—å –≤ Linux.

* Linux –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –±–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º - –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã —ç—Ç–æ –±—ã–ª–æ –≤–æ–∑–º–æ–∂–Ω–æ –≤ VFS –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, –æ–ø—Ä–µ–¥–µ–ª—è—é—â–∞—è —Ç–∏–ø —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã - `struct file_system_type`

* –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ `file_system_file`, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ç–æ–≥–æ, —Å–∫–æ–ª—å–∫–æ —Ç–∞–∫–∏—Ö —Ñ–∞–π–ª–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ –∏ —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —ç–∫–∑–µ–º–ø–ª—è—Ä —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã.

## –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã

–î–ª—è —Å–≤—è–∑—ã–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã —Å VFS –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–µ–∫–∏–π –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä —Ñ—É–Ω–∫—Ü–∏–π –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä –¥–∞–Ω–Ω—ã—Ö:

* `struct file_system_type` —è–≤–ª—è–µ—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω—ã–º "–æ–ø—Ä–µ–¥–µ–ª–∏—Ç–µ–ª–µ–º" —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–º—è –§–°, –∞ —Ç–∞–∫–∂–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏—è —Å—É–ø–µ—Ä–±–ª–æ–∫–∞.
* `struct super_operations` —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–∞–±–æ—Ä —Ñ—É–Ω–∫—Ü–∏–π —Ä–∞–±–æ—Ç—ã —Å –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã. –ó–¥–µ—Å—å –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è "–∑–∞–≥–ª—É—à–∫–∏", –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º—ã–µ `libfs`.
* `struct file_operations` –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–∞–±–æ—Ä —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–∞–º–∏. –î–ª—è —Ñ–∞–π–ª–æ–≤ c—á–µ—Ç—á–∏–∫–æ–≤ –º—ã —Ä–µ–∞–ª–∏–∑—É–µ–º —Ç–æ–ª—å–∫–æ —Ç—Ä–∏ –∏–∑ –Ω–∏—Ö: `open`, `read` –∏ `write`; –¥–ª—è –∫–∞—Ç–∞–ª–æ–≥–æ–≤ –∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º "–∑–∞–≥–ª—É—à–∫–∏" `libfs`.

–ö–æ–¥ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∏–ª–∏ –≤ –≤–∏–¥–µ –∑–∞–≥—Ä—É–∂–∞–µ–º–æ–≥–æ –º–æ–¥—É–ª—è —è–¥—Ä–∞, –∏–ª–∏ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≤—è–∑–∞–Ω —Å —è–¥—Ä–æ–º.

–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã –Ω–∞–¥–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –ø–æ–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã `struct file_system_file` –∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É VFS —Å –ø–æ–º–æ—â—å—é —Å–ª–µ–¥—É—é—â–∏—Ö —Ñ—É–Ω–∫—Ü–∏–∏ API:

```
#include <linux/fs.h>
extern int register_filesystem (struct file_system_type *); 
extern int unregister_filesystem (struct file_system_type *);
```

–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –º–æ–¥—É–ª—è. –î–ª—è –¥–µ—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏—è `unregister_filesystem()`, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ —Ñ—É–Ω–∫—Ü–∏–∏ –≤—ã—Ö–æ–¥–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º–æ–≥–æ –º–æ–¥—É–ª—è.

–û–±–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–∏–Ω–∏–º–∞—é—Ç –∫–∞–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—É `file_system_type`, –∫–æ—Ç–æ—Ä–∞—è "–æ–ø–∏—Å—ã–≤–∞–µ—Ç" —Å–æ–∑–¥–∞–≤–∞–µ–º—É—é —Ñ–∞–π–ª–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É.

–ù–∞–ø—Ä–∏–º–µ—Ä:
```
struct file_system_file my_fs_type = {
    .owner = THIS_MODULE,
    .name = ‚Äúmy_fs‚Äù,
    .mount = my_mount,
    .kill_sb = my_kill_super_block,
    .fs_flags = FS_REQUIRED_DEV,
};
```

* –ü–æ–ª–µ `owner` –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Å—á–µ—Ç—á–∏–∫ —Å—Å—ã–ª–æ–∫ –Ω–∞ –º–æ–¥—É–ª—å, —á—Ç–æ–±—ã –µ–≥–æ –Ω–µ–ª—å–∑—è –±—ã–ª–æ —Å–ª—É—á–∞–π–Ω–æ –≤—ã–≥—Ä—É–∑–∏—Ç—å. 

–ù–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ —Ñ–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –±—ã–ª–∞ –ø–æ–¥–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞, —Ç–æ –≤—ã–≥—Ä—É–∑–∫–∞ –º–æ–¥—É–ª—è –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –∫—Ä–∞—Ö—É, –Ω–æ —Å—á–µ—Ç—á–∏–∫ —Å—Å—ã–ª–æ–∫ –Ω–µ –ø–æ–∑–≤–æ–ª–∏—Ç –≤—ã–≥—Ä—É–∑–∏—Ç—å –º–æ–¥—É–ª—å –ø–æ–∫–∞ –æ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, —Ç.–µ. –ø–æ–∫–∞ —Ñ–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –±—É–¥–µ—Ç —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞.

* –ü–æ–ª–µ `name` —Ö—Ä–∞–Ω–∏—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã. –ò–º–µ–Ω–Ω–æ —ç—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ø—Ä–∏ –µ–µ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏.

* `mount` –∏ `kill_sb` –¥–≤–∞ –ø–æ–ª—è, —Ö—Ä–∞–Ω—è—â–∏–µ —É–∫–∞–∑–∞—Ç–µ–ª–∏ –Ω–∞ —Ñ—É–Ω–∫—Ü–∏–∏ - –ø–µ—Ä–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω–∞ –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã, –∞ –≤—Ç–æ—Ä–∞—è –ø—Ä–∏ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏. –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤—Å–µ–≥–æ –æ–¥–Ω—É, –∞ –≤–º–µ—Å—Ç–æ –≤—Ç–æ—Ä–æ–π –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `kill_block_super`, –∫–æ—Ç–æ—Ä—É—é –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —è–¥—Ä–æ, –∏–ª–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é generic-—Ñ—É–Ω–∫—Ü–∏—é.

–ö–æ–≥–¥–∞ –¥–µ–ª–∞–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å –Ω–∞ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã –≤ –∫–∞—Ç–∞–ª–æ–≥ –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–º
–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ –∏–º–µ–Ω, VFS –≤—ã–∑—ã–≤–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥ `mount()` –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ñ–∞–π–ª–æ–≤–æ–π
—Å–∏—Å—Ç–µ–º—ã.

–í –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ `super_block`: –º–∞–≥–∏—á–µ—Å–∫–æ–µ —á–∏—Å–ª–æ, –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É –¥—Ä–∞–π–≤–µ—Ä —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã –º–æ–∂–µ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –∏–º–µ–Ω–Ω–æ —Ç–∞ —Å–∞–º–∞—è —Ñ–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞, –∞ –Ω–µ —á—Ç–æ-—Ç–æ –µ—â–µ –∏–ª–∏ –ø—Ä–æ—á–∏–µ –¥–∞–Ω–Ω—ã–µ; –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è —Å—É–ø–µ—Ä–±–ª–æ–∫–∞, –µ–≥–æ —Ä–∞–∑–º–µ—Ä. –î–ª—è –º–∞–≥–∏—á–µ—Å–∫–æ–≥–æ —á–∏—Å–ª–∞ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª—é–±–æ–µ —Å–æ—á–µ—Ç–∞–Ω–∏–µ —Ü–∏—Ñ—Ä.

–ü—Ä–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–≤ —Å—É–ø–µ—Ä–±–ª–æ–∫, —Ñ—É–Ω–∫—Ü–∏—è `myfs_fill_sb()` —Å–æ–∑–¥–∞–µ—Ç –∫–æ—Ä–Ω–µ–≤–æ–π –∫–∞—Ç–∞–ª–æ–≥ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã. –î–ª—è –Ω–µ–≥–æ —Å–æ–∑–¥–∞–µ—Ç—Å—è `inode` –≤—ã–∑–æ–≤–æ–º `myfs_make_inode`. –û–Ω –Ω—É–∂–¥–∞–µ—Ç—Å—è –≤ —É–∫–∞–∑–∞—Ç–µ–ª–µ –Ω–∞ —Å—É–ø–µ—Ä–±–ª–æ–∫ –∏ –∞—Ä–≥—É–º–µ–Ω—Ç–µ `mode`, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–¥–∞–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ —Å–æ–∑–¥–∞–≤–∞–µ–º—ã–π —Ñ–∞–π–ª –∏ –µ–≥–æ —Ç–∏–ø (–º–∞—Å–∫–∞ S_IFDIR –≥–æ–≤–æ—Ä–∏—Ç —Ñ—É–Ω–∫—Ü–∏–∏, —á—Ç–æ –º—ã —Å–æ–∑–¥–∞–µ–º –∫–∞—Ç–∞–ª–æ–≥). –§–∞–π–ª–æ–≤—ã–µ –∏ inode-–æ–ø–µ—Ä–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –º—ã –Ω–∞–∑–Ω–∞—á–∞–µ–º –Ω–æ–≤–æ–º—É `inode`, –≤–∑—è—Ç—ã –∏–∑ `libfs`, —Ç.–µ. –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—Ç—Å—è —è–¥—Ä–æ–º.

–î–∞–ª–µ–µ –¥–ª—è –∫–æ—Ä–Ω–µ–≤–æ–≥–æ –∫–∞—Ç–∞–ª–æ–≥–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ `dentry`, —á–µ—Ä–µ–∑ –∫–æ—Ç–æ—Ä—É—é –æ–Ω –ø–æ–º–µ—â–∞–µ—Ç—Å—è –≤ `directory-–∫—ç—à. –ó–∞–º–µ—Ç–∏–º, —á—Ç–æ —Å—É–ø–µ—Ä–±–ª–æ–∫ –∏–º–µ–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –ø–æ–ª–µ, —Ö—Ä–∞–Ω—è—â–µ–µ —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ `dentry –∫–æ—Ä–Ω–µ–≤–æ–≥–æ –∫–∞—Ç–∞–ª–æ–≥–∞, –∫–æ—Ç–æ—Ä–æ–µ —Ç–∞–∫–∂–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è myfs_fill_sb.

–í `put_super()` –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –¥–µ—Å—Ç—Ä—É–∫—Ç–æ—Ä —Å—É–ø–µ—Ä–±–ª–æ–∫–∞ —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º–æ–π —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã. –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω—è—é—Ç—Å—è –∑–∞–≥–ª—É—à–∫–∞–º–∏ –∏–∑ `libfs`.

–°–±–æ—Ä–∫–∞ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –¥—Ä–∞–π–≤–µ—Ä–∞ —Å–∏—Å—Ç–µ–º—ã –Ω–∏—á–µ–º –Ω–µ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç —Å–±–æ—Ä–∫–∏ –∏ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—ã—á–Ω–æ–≥–æ –º–æ–¥—É–ª—è, —Ç.–µ. –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —É–∂–µ –∑–Ω–∞–∫–æ–º—ã–µ –∫–æ–º–∞–Ω–¥—ã `insmod` –∏ `rmmod`.
–í–º–µ—Å—Ç–æ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –¥–∏—Å–∫–∞ –¥–ª—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤ –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `loop` —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ. –≠—Ç–æ —Ç–∞–∫–æ–π –¥—Ä–∞–π–≤–µ—Ä "–¥–∏—Å–∫–∞", –∫–æ—Ç–æ—Ä—ã–π –ø–∏—à–µ—Ç –¥–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ, –∞ –≤ —Ñ–∞–π–ª (–æ–±—Ä–∞–∑ –¥–∏—Å–∫–∞). 

## –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é - –∫—ç—à slab

–†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç–µ–ª—å –ø–∞–º—è—Ç–∏ slab, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –≤ Linux, —Å—Ç—Ä–æ–∏—Ç—Å—è –≤–æ–∫—Ä—É–≥ –æ–±—ä–µ–∫—Ç–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è. –í–Ω—É—Ç—Ä–∏ —è–¥—Ä–∞ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞–º—è—Ç–∏ –≤—ã–¥–µ–ª—è–µ—Ç—Å—è –Ω–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –Ω–∞–±–æ—Ä –æ–±—ä–µ–∫—Ç–æ–≤, –Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä—ã —Ñ–∞–π–ª–æ–≤ –∏ –¥—Ä—É–≥–∏–µ –æ–±—â–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—Ä–µ–º–µ–Ω–∏, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–µ–≥—É–ª—è—Ä–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –≤ —è–¥—Ä–µ, –ø—Ä–µ–≤—ã—à–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—Ä–µ–º–µ–Ω–∏, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ –¥–ª—è –µ–≥–æ –≤—ã–¥–µ–ª–µ–Ω–∏—è –∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è. –ò–¥–µ—è —Å–æ—Å—Ç–æ—è–ª–∞ –≤ —Ç–æ–º, —á—Ç–æ –≤–º–µ—Å—Ç–æ —Ç–æ–≥–æ, —á—Ç–æ–±—ã –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –æ—Å–≤–æ–±–æ–¥–∏–≤—à—É—é—Å—è –ø–∞–º—è—Ç—å –≤ –æ–±—â–∏–π —Ñ–æ–Ω–¥, –æ—Å—Ç–∞–≤–ª—è—Ç—å —ç—Ç—É –ø–∞–º—è—Ç—å –≤ –ø—Ä–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Ç–µ—Ö –∂–µ —Ü–µ–ª—è—Ö. 

–ù–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –ø–∞–º—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∞ –¥–ª—è mutex, —Ñ—É–Ω–∫—Ü–∏—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ mutex (mutex_init) –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑, –∫–æ–≥–¥–∞ –ø–∞–º—è—Ç—å –≤–ø–µ—Ä–≤—ã–µ –≤—ã–¥–µ–ª—è–µ—Ç—Å—è –¥–ª—è mutex. –ü–æ—Å–ª–µ–¥—É—é—â–∏–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏ –Ω–µ —Ç—Ä–µ–±—É—é—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏, –ø–æ—Å–∫–æ–ª—å–∫—É –æ–Ω–∞ —É–∂–µ –∏–º–µ–µ—Ç –Ω—É–∂–Ω—ã–π —Å—Ç–∞—Ç—É—Å –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –∏ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –¥–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä—É.

### –§—É–Ω–∫—Ü–∏–∏ API

–ü–µ—Ä–≤—ã–π —ç—Ç–∞–ø - —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∫—ç—à–∞ slab, –∫–æ—Ç–æ—Ä—É—é –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏ –∫–∞–∫:
```
struct struct kmem_cache *my_cachep;
struct kmem_cache *kmem_cache_create( const char *name, size_t size, size_t align, unsigned long flags, void (*ctor)(void*, struct kmem_cache *, unsigned long), void (*dtor)(void*, struct kmem_cache *, unsigned long));
```

–≠—Ç–∞ —Å—Å—ã–ª–∫–∞ –∑–∞—Ç–µ–º –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–∏–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –∫—ç—à–∞ slab –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è, —É–¥–∞–ª–µ–Ω–∏—è, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏ —Ç.–¥. 

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ `kmem_cache` —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ, –æ—Ç–Ω–æ—Å—è—â–∏–µ—Å—è –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º CPU-–º–æ–¥—É–ª—è–º, –Ω–∞–±–æ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–∫ (–¥–æ—Å—Ç—É–ø–Ω—ã—Ö —á–µ—Ä–µ–∑ —Ñ–∞–π–ª–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É proc), —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤, –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—ç—à–µ–º slab.

–§—É–Ω–∫—Ü–∏—è —è–¥—Ä–∞ `kmem_cache_create()` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∫—ç—à–∞. –û–±—ã—á–Ω–æ —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤–æ –≤—Ä–µ–º—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —è–¥—Ä–∞ –∏–ª–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ –º–æ–¥—É–ª—è —è–¥—Ä–∞. –ï–≥–æ –ø—Ä–æ—Ç–æ—Ç–∏–ø –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –∫–∞–∫: 

* `name` ‚Äî —Å—Ç—Ä–æ–∫–∞ –∏–º–µ–Ω–∏ –∫—ç—à–∞;
* `size` ‚Äî —Ä–∞–∑–º–µ—Ä —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∫—ç—à–∞ (–µ–¥–∏–Ω—ã–π –∏ –æ–±—â–∏–π –¥–ª—è –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤);
* `offset` ‚Äî —Å–º–µ—â–µ–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –æ—Ç –Ω–∞—á–∞–ª–∞ –∫—ç—à–∞ (–¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è –ø–æ –≥—Ä–∞–Ω–∏—Ü–∞–º —Å—Ç—Ä–∞–Ω–∏—Ü, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —É–∫–∞–∑–∞—Ç—å 0, —á—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é);
* `flags` ‚Äî –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–º–æ–∂–µ—Ç –±—ã—Ç—å 0);
* `ctor`, `dtor` ‚Äî –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∏ –¥–µ—Å—Ç—Ä—É–∫—Ç–æ—Ä, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ, –≤—ã–∑—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏–∏-–æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–∏ –∫–∞–∂–¥–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞, –Ω–æ —Å –Ω–µ–∫–æ—Ç–æ—Ä—ã–º–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏; –Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–µ—Å—Ç—Ä—É–∫—Ç–æ—Ä –±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è (—Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è), –Ω–æ –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è, —á—Ç–æ —ç—Ç–æ –±—É–¥–µ—Ç –ø–æ–∏—Å—Ö–æ–¥–∏—Ç—å —Å—Ä–∞–∑—É –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞.

–ò–∑ —Ñ–ª–∞–≥–æ–≤ —Å–æ–∑–¥–∞–Ω–∏—è, –ø–æ—Å–∫–æ–ª—å–∫—É –æ–Ω–∏ —Ç–∞–∫–∂–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏, –∏ –±–æ–ª—å—à–∞—è —á–∞—Å—Ç—å –∏–∑ –Ω–∏—Ö –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –æ—Ç–ª–∞–¥–æ—á–Ω—ã–º –æ–ø—Ü–∏—è–º, —Å—Ç–æ–∏—Ç –Ω–∞–∑–≤–∞—Ç—å:
* `SLAB_HWCACHE_ALIGN` ‚Äî —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ —Å–ª–∞–±–µ –¥–æ–ª–∂–Ω–æ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞—Ç—å—Å—è –ø–æ —Å—Ç—Ä–æ–∫–∞–º –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–Ω–æ–≥–æ –∫—ç—à–∞, —ç—Ç–æ –º–æ–∂–µ—Ç —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ –ø–æ–¥–Ω—è—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –Ω–æ –Ω–µ–ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ —Ä–∞—Å—Ö–æ–¥—É–µ—Ç—Å—è –ø–∞–º—è—Ç—å;

* `SLAB_POISON` ‚Äî –Ω–∞—á–∞–ª—å–Ω–æ –∑–∞–ø–æ–ª–Ω—è–µ—Ç —Å–ª–∞–± –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º (A5A5A5A5) –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –≤—ã–±–æ—Ä–∫–∏ –Ω–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π;

–ï—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω—ã –∫–∞–∫–∏–µ-—Ç–æ –æ—Å–æ–±—ã–µ –∏–∑—ã—Å–∫–∏, —Ç–æ –Ω—É–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –±—É–¥–µ—Ç –≤–ø–æ–ª–Ω–µ —É–º–µ—Å—Ç–Ω–æ –¥–ª—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ flags.

–ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ –∫—ç—à —Å–æ–∑–¥–∞–Ω, —Å—Å—ã–ª–∫–∞ –Ω–∞ –Ω–µ–≥–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏–µ–π `kmem_cache_create`. –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ, —á—Ç–æ —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –≤—ã–¥–µ–ª—è–µ—Ç –ø–∞–º—è—Ç—å –∫–µ—à—É. –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –≤—ã–¥–µ–ª–∏—Ç—å –æ–±—ä–µ–∫—Ç—ã –∏–∑ –∫—ç—à–∞ (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –æ–Ω –ø—É—Å—Ç) –µ–º—É –≤—ã–¥–µ–ª—è–µ—Ç—Å—è –ø–∞–º—è—Ç—å –ø—Ä–∏ –ø–æ–º–æ—â–∏ –∫–æ–º–∞–Ω–¥—ã `refill`. –≠—Ç–æ —Ç–∞ –∂–µ –∫–æ–º–∞–Ω–¥–∞, –∫–æ—Ç–æ—Ä–∞—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫—ç—à—É –ø–∞–º—è—Ç–∏, –∫–æ–≥–¥–∞ –≤—Å–µ –µ–≥–æ –æ–±—ä–µ–∫—Ç—ã –∏–∑—Ä–∞—Å—Ö–æ–¥–æ–≤–∞–Ω—ã.
–ö–∞–∫ –¥–ª—è –ª—é–±–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–¥–µ–ª–µ–Ω–∏—è, –µ–π —Å–æ–ø—É—Ç—Å—Ç–≤—É–µ—Ç –æ–±—Ä–∞—Ç–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –ø–æ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏—é —Å–ª–∞–±–∞: 

```
int kmem_cache_destroy( kmem_cache_t *cache );
```

–û–ø–µ—Ä–∞—Ü–∏—è —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å —É—Å–ø–µ—à–Ω–∞ (–∑–¥–µ—Å—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ–¥–∫–∏–π —Å–ª—É—á–∞–π, –∫–æ–≥–¥–∞ —Ñ—É–Ω–∫—Ü–∏—è —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞), —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É–∂–µ –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã, –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –∏–∑ –∫—ç—à–∞, –±—ã–ª–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã –≤ –Ω–µ–≥–æ. –¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –º–æ–¥—É–ª—å –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å, –≤–æ–∑–≤—Ä–∞—â—ë–Ω–Ω—ã–π `kmem_cache_destroy()`; –æ—à–∏–±–∫–∞ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –∫–∞–∫–æ–π-—Ç–æ –≤–∏–¥ —É—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏ –≤ –º–æ–¥—É–ª–µ (—Ç–∞–∫ –∫–∞–∫ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –æ–±—ä–µ–∫—Ç—ã –Ω–µ –±—ã–ª–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã).

–ü–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –∫—ç—à –æ–±—ä–µ–∫—Ç–æ–≤ —Å–æ–∑–¥–∞–Ω, –≤—ã –º–æ–∂–µ—Ç–µ –≤—ã–¥–µ–ª—è—Ç—å –æ–±—ä–µ–∫—Ç—ã –∏–∑ –Ω–µ–≥–æ, –≤—ã–∑—ã–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—é `kmem_cache_alloc()`. –í—ã–∑—ã–≤–∞—é—â–∏–π –∫–æ–¥ –ø–µ—Ä–µ–¥–∞–µ—Ç –∫—ç—à, –∏–∑ –∫–æ—Ç–æ—Ä–æ–≥–æ –≤—ã–¥–µ–ª—è–µ—Ç—Å—è –æ–±—ä–µ–∫—Ç, –∏ –Ω–∞–±–æ—Ä —Ñ–ª–∞–≥–æ–≤:

```
void kmem_cache_free( kmem_cache_t *cache, const void *obj );
```

## –í–æ–ø—Ä–æ—Å—ã

* –ö–∞–∫ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É?

*–ü—Ä–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã `file_system_type` –∏ –ø–µ—Ä–µ–¥–∞—Ç—å –µ–µ –≤ `register_filesystem`*

* –ö–∞–∫ —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É?

1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å mount –≤ `file_system_type`
2. –î–∞–ª—å—à–µ –ø–æ –∫–æ–¥—É: –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `mount_[b|no]dev` –≤ –Ω–µ–µ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è `fill_super` (—Ñ—É–Ω–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è—é—â–∞—è –æ—Å–Ω–æ–≤–Ω—É—é —Ä–∞–±–æ—Ç—É). –í –Ω–µ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è –ø–æ–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å—É–ø–µ—Ä–±–ª–æ–∫ –∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è `inode` –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –ø–æ–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã `inode` –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø–æ–ª–µ `s_root` —Å—É–ø–µ—Ä–±–ª–æ–∫–∞. –≠—Ç–æ—Ç `inode` –Ω—É–∂–µ–Ω –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–æ—Ä–Ω–µ–≤–æ–≥–æ –∫–∞—Ç–∞–ª–æ–≥–∞ —Å—É–ø–µ—Ä–±–ª–æ–∫–∞.

* –°–º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –§–° –≤ –¥–≤–µ –ø–∞–ø–∫–∏ –∏ –ø–æ–∫–∞–∑–∞—Ç—å.

```
/proc/mount (—á—Ç–æ –æ–Ω–∞ —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞ 2 —Ä–∞–∑–∞)
/proc/filesystems (—á—Ç–æ –æ–Ω–∞ –∑–∞—Ä–µ–≥–∞–Ω–∞)
lsmod (—á—Ç–æ –æ–Ω–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏ —Ç–∞–º 2 —Å—Å—ã–ª–∫–∏)
/proc/slabinfo –ø–æ–∫–∞–∑–∞—Ç—å —Å–ª–∞–± –∫—ç—à
```

* –ù—É–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å —Å–ª–∞–± –∫—ç—à

```
myvfs_cache           128    128     32    1 : tunables    0    0    0 : slabdata     1    1      0
```

–±—É–¥–µ—Ç —á—Ç–æ-—Ç–æ —Ç–∞–∫–æ–µ –≤ `slabinfo`. –ù—É–∂–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å –≤ —Ü–∏–∫–ª–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–∑–¥–∞–≤–∞–µ–º—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä –Ω–∞ 130

```
for (int i = 0; i < 130; i++) {
    cache_mem[i] = kmem_cache_alloc(cache, GFP_KERNEL);
    ...
}
```

–ò –ø–æ–∫–∞–∑–∞—Ç—å —á—Ç–æ —Ç—É—Ç 2 —Ç–µ–ø–µ—Ä—å
```
myvfs_cache           256    256     32    1 : tunables    0    0    0 : slabdata     2    2      0
```

* –ó–∞—á–µ–º —Å–ª–∞–±—ã?

*–î–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤. –ü–æ–±–æ—á–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç - —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏–∏ (–∑–∞ —Å—á–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤)*

1. –≥–¥–µ —É –Ω–∞—Å –≤ –∫–æ–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è slab (–∫–µ—à)
- —Ç–∞–º —Ç—ã–∫–Ω–∏ –µ–π –≤ md_init –Ω–∞ —Ñ—É–Ω–∫—Ü–∏—é <—á—Ç–æ-—Ç–æ —Ç–∞–º>_alloc
1. –∫–æ–≥–¥–∞ —É –Ω–∞—Å —Å–æ–∑–¥–∞—ë—Ç—Å—è –Ω–æ–≤—ã–π slab?
- –∫–æ–≥–¥–∞ —É –Ω–∞—Å –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è —Å—Ç–∞—Ä—ã–π
–¢–∞–º –µ—â—ë –Ω–∞–¥–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≥—É —Å 130 –æ–±—ä–µ–∫—Ç–∞–º–∏ (cache_count –≤ –õ–µ—Ä–∏–Ω–æ–º –∫–æ–¥–µ –ø–æ–º–µ–Ω—è–ª —Å 1 –Ω–∞ 130) –∏ –ø–æ–∫–∞–∑–∞—Ç—å –≤ /proc/slabinfo —á—Ç–æ –Ω–∞—à —Å–ª–µ–± —Ü–∏—Ñ–æ—Ä–∫–∞ 2 –µ—Å—Ç—å
1. —Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞
- init, exit, mount, kill_superblock
1. –∫–æ–≥–¥–∞ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è mount
- –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã mount –≤ –∫–æ–Ω—Å–æ–ª–µ
1. –∫–æ–≥–¥–∞ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è kill_superblock
- –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã unmount (–æ–Ω–∞ –∞–≥—Ä–∏—Ç—å—Å—è –µ—Å–ª–∏ –Ω–∞–∑–≤–∞—Ç—å –µ—ë umount) –≤ –∫–æ–Ω—Å–æ–ª–∏

–í–æ–ø—Ä–æ—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–∞–≥–∏—Å—Ç—Ä –∑–∞–¥–∞–≤–∞–ª –ø–æ vfs –∏ –≤–æ–∑–º–æ–∂–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –Ω–∏—Ö

–ó–∞—á–µ–º vfs?
–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –∫–æ—Ç–æ—Ä—ã–π —É–Ω–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –¥–æ—Å—Ç—É–ø –∫ —Ñ–∞–π–ª–∞–º

–ó–∞—á–µ–º –∏–Ω–¥–µ–∫—Å–Ω—ã–π –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä?
–î–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –±–ª–æ–∫–æ–≤ –ø–∞–º—è—Ç–∏ –Ω–∞ –¥–∏—Å–∫–µ, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ—Å—Ç–∞–≤–ª—è—é—Ç —Ñ–∞–π–ª

–ö–∞–∫–∏–µ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏?
–°—É–ø–µ—Ä –±–ª–æ–∫, —Ñ–∞–π–ª,  inod, struct dentry

–ö–∞–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–∞–¥ —ç—Ç–∏–º–∏ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è–º–∏?
–°–æ–∑–¥–∞–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ, time (?), –∫–æ–º—É —Ä–∞–∑—Ä–µ—à–µ–Ω–æ —á–∏—Ç–∞—Ç—å/–ø–∏—Å–∞—Ç—å (?)

–ß—Ç–æ –æ–Ω–∞ –ø—Ä–æ—Å–∏—Ç –ø–æ–∫–∞–∑–∞—Ç—å?

Stepa, [13.06.2024 12:30]
–ú–∞—É–Ω—Ç –≤ —Ä–∞–∑–Ω—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏

Stepa, [13.06.2024 12:30]
–ü–æ–∫–∞–∑–∞—Ç—å, —á—Ç–æ —Å–∏—Å—Ç–µ–º–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞

Stepa, [13.06.2024 12:30]
–ò –ø–æ –∫–æ–¥—É

–ï–∫–∞—Ç–µ—Ä–∏–Ω–∞ –°–∞–º–∞—Ä–∏–Ω–∞, [13.06.2024 14:30]
VFS:
–Ø –ø–æ–¥–æ—à–ª–∞ —Å—Ä–∞–∑—É —Å –¥–≤–∞–∂–¥—ã –ø–æ–¥–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –º–æ–µ–π —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π.

1. –ü–æ–∫–∞–∂–∏—Ç–µ, —á—Ç–æ –æ–Ω–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞
cat /proc/filesystems
–¢–∞–º –≤ —Å–∞–º–æ–º –Ω–∏–∑—É –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤–∞—à–∞ –§–°
2. –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å, —á—Ç–æ–±—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –§–°? –ü—Ä—è–º –ø–æ –∫–æ–¥—É
–ü—Ä–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã file_system_type, –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –Ω–∞–ø–∏—Å–∞–≤ —Ñ—É–Ω–∫—Ü–∏–∏ mount –∏ kill_block_super. –î–∞–ª–µ–µ —ç–∫–∑–µ–º–ø–ª—è—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø–µ—Ä–µ–¥–∞—Ç—å –≤ register_filesystem (–¥–≤–æ–π–Ω–∏–∫ - —Ñ—É–Ω–∫—Ü–∏—è unregister_filesystem)

–î–∞–ª–µ–µ –ø–æ—à–ª–∏ –ø–æ –∫–æ–¥—É mount. –¢–∞–º –≤—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é mount_nodev, –∫—É–¥–∞ –ø–µ—Ä–µ–¥–∞–µ–º –æ–ø—è—Ç—å –∂–µ –∑–∞—Ä–∞–Ω–µ–µ –Ω–∞–ø–∏—Å–∞–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é fill_sb. –î–∞–ª–µ–µ –∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–µ–º –∫–æ–¥ fill_sb. –¢–∞–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã struct superblock. –î–∞–ª–µ–µ –æ–Ω–∞ —á—Ç–æ-—Ç–æ –Ω–∞—á–∞–ª–∞ —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å –ø—Ä–æ inode, –Ω–æ –≤ –∏—Ç–æ–≥–µ –æ—Ç–≤–µ—Ç–∏–ª–∞ –∑–∞ –º–µ–Ω—è, –∏ —è –µ—Å–ª–∏ —á–µ—Å—Ç–Ω–æ, –ø–æ—á—Ç–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–Ω—è–ª–∞üòÖ
–î–∞–ª–µ–µ –æ–Ω–∞ —Å–ø—Ä–æ—Å–∏–ª–∞, –≥–¥–µ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ—Ä–Ω–µ–≤–æ–≥–æ –∫–∞—Ç–∞–ª–æ–≥–∞ (–∏–ª–∏ —á—Ç–æ-—Ç–æ —Ç–∏–ø–∞ —Ç–æ–≥–æ). –≠—Ç–æ –º—ã –¥–µ–ª–∞–µ–º –∫–æ–º–∞–Ω–¥–æ–π –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ mkdir, –ø–æ—Ç–æ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–Ω–æ–π –ø–∞–ø–∫–µ –ø–µ—Ä–µ–¥–∞–µ–º –∫–æ–º–∞–Ω–¥–µ mount

–∑–∞—á–µ–º –Ω—É–∂–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å—É–ø–µ—Ä–±–ª–æ–∫? –≤—Ñ—Å
—Å–ø–∞—Å–∏—Ç–µ —á–µ–ª–æ–≤–µ–∫–∞ 

—Ö–∞—Ö–∞—Ö–∞—Ö–∞—Ö

–û–ø–∏—Å—ã–≤–∞–µ—Ç –°–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Ñ–∞–π–ª–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É