# Сокеты

**Сокеты** - универсальное средство взаимодействия параллельных процессов, причем безразлично, где они выполняются: на одной машине или на разных. 

**Сокет представляет собой абстракцию конечной точки взаимодействия, у него нет адреса. Взаимдействие в сети выполняется через сетевой сокет.**

```
int socket(int domain, int type, int protocol);  
```

`socket` - создает конечную точку соединения (сокет) и возвращает ее дескриптор.

`domain`(family) - задает домен соединения или семейство адресов.

*AF_UNIX* - сокеты в пространстве файловых имен;

*AF_INET, PA_INET6* -- сетевые сокеты по протоколу TPC/IP для сетей IPv4 / IPv6.

`type` - задает семантику коммуникации, тип сокета.

*SOCK_STREAM* - обеспечивает создание двусторонних надежных и последовательных потоков байтов, поддерживающих соединения.

*SOCK_DGRAM* - поддерживает датаграммы (ненадежные сообщения с ограниченной длиной и не поддерживающие соединения).

Взаимодействие в сети выполняется через __сетевой адрес__.

`protocol` - задает определённый протокол, используемый с
сокетом. Обычно, только единственный протокол существует для поддержи определённого типа сокета с заданным семейством протоколов. В этом случае для параметра protocol можно указать 0. Однако, может существовать несколько протоколов.
Номер используемого протокола зависит от домена соединения, по которому устанавливается соединение.


## Адреса сокетов

Функция `socket()` создает "безымянный" сокет, т.е. не связанный ни с локальным адресом, ни с номером порта. Прежде чем передавать данные через сокет, его необходимо связать с адресом в выбранном домене (эту процедуру называют именованием сокета). Иногда связывание осуществляется неявно (внутри функций `connect` и `accept`), но выполнять его необходимо во всех случаях. 

Вид адреса зависит от выбранного вами домена. **В Unix-домене это текстовая строка - имя файла, через который происходит обмен данными. В Internet-домене адрес задаётся комбинацией IP-адреса и 16-битного номера порта. IP-адрес определяет хост в сети, а порт - конкретный сокет на этом хосте.** Протоколы TCP и UDP используют различные пространства портов.

Специальный тип сокетов **sockpair** - парные сокеты, альтернатива `pipe`.

Параметры: домен, тип, протокол, массив из двух элементов.

Парные сокеты обеспечивают дублексную связь - тоже вызываются системные вызовы open/close, но для указания сторон взаимодействия. 

## Клиент

1. `socket()` - создает безымянный сокет.
2. Получает информацию от сервeра для заполнения полей структуры `sockaddr_in`, чтобы сервер мог ответить клиенту, если это нужно - происходит связывание `bind()`; иначе - связывание не происходит.
3. `connect()` - запрос соединения с сервером (-> после `listen` сервер блокируется в ожидании)
4. После того как сервер примет соединение (`accept`->) клиент может писать и читать `write()`, `read()` и т.д.
5. `close()` - закрывает сокет.

## Сервер 

1. `socket()` - создает безымянный сокет.
2. Заполняет поля структуры `sockaddr_in`после чего связывает сокет с адресом - `bind()`.
3. `listen()` - сообщает системе ОС, на которой установлен сервер, что сервер неявно ожидает сетевое соеденение - блокируется в ожидании.
4. Если получает запрос на соединение с сервером от клиента (`connect()`), то принимает соеденение с помощью системного вызова `accept()`, после чего происходит соеденение сервера с клиентом.
5. Сервер может писать и читать `write()`, `read()` и т.д.
6. `close()` - закрывает сокет.

**`accept()`** создает копию исходного сокета, при этом исходный сокет остается в состоянии `listen`, а копия - `connected`, то есть сервер продолжает прослушивать следующие соединения.